---
import Layout from '../layouts/Layout.astro';
import { getHeroOverlay, getDynamicMessage } from '../utils/tempColors';

const { vibe } = Astro.locals;

// Get temperature-based overlay
const overlay = getHeroOverlay(vibe.metrics.mentalTemp, vibe.social.jetsStatus);

// Get dynamic message
const welcomeMessage = getDynamicMessage({
  temp: vibe.weather.temp,
  mentalTemp: vibe.metrics.mentalTemp,
  jetsStatus: vibe.social.jetsStatus,
  isGrind: vibe.grind.isGrind,
  grindDays: vibe.grind.coldStreakDays,
  holiday: vibe.temporal.holiday.holidayName,
  deviation: vibe.metrics.deviation,
  deltaShock: vibe.metrics.deltaShock
});
---

<Layout title="Home" useDefaultContainer={false}>
  <!-- Main Wrapper: Split on Desktop, Stacked on Mobile -->
  <div class="flex flex-col md:flex-row min-h-screen">

      <!-- LEFT COLUMN: Hero Video (Sticky on Desktop) -->
      <div class="w-full md:w-1/2 h-[60vh] md:h-screen md:sticky md:top-0 relative overflow-hidden border-b md:border-b-0 md:border-r border-stone-200" style={`background-color: ${vibe.theme.colors.bg}`}>

          <!-- Video Container with Parallax Hook -->
          <div class="parallax-video-container absolute inset-0 w-full h-full z-0">
               <video
                  class="w-full h-full object-cover transition-transform duration-100 ease-linear will-change-transform"
                  autoplay
                  loop
                  muted
                  playsinline
                  poster="https://images.unsplash.com/photo-1556910103-1c02745a30bf?auto=format&fit=crop&w=800&q=80"
               >
                  <source src="/kitchen-loop.mp4" type="video/mp4" />
               </video>
          </div>

          <!-- Temperature-Based Gradient Overlay -->
          <!-- -50Â°C = pink/purple, 0Â°C = blue, 30Â°C = red, 45Â°C = black -->
          <!-- Jets win = red + blue gradient -->
          <div 
            class="absolute inset-0 z-5 transition-all duration-1000"
            style={`background: ${overlay.background}; mix-blend-mode: ${overlay.mixBlend};`}
            aria-hidden="true"
          ></div>

          <!-- Hero Content Overlay -->
          <div class="absolute inset-0 z-10 flex flex-col items-center justify-center text-center p-8 pointer-events-none" style={`color: ${vibe.theme.colors.text}`}>
               <h1 class="hero-text text-[71px] md:text-8xl font-logo mb-4 drop-shadow-lg">Buvette</h1>
               <p class="text-xl md:text-2xl font-light tracking-wide drop-shadow-md max-w-md mb-6">
                 {welcomeMessage}
               </p>
               <p class="text-sm opacity-80 drop-shadow-sm">
                 {vibe.weather.temp.toFixed(0)}Â°C (Feels like {vibe.metrics.mentalTemp.toFixed(0)}Â°C)
               </p>
          </div>
      </div>

      <!-- RIGHT COLUMN: Scrollable Content -->
      <div class="w-full md:w-1/2 transition-colors duration-1000" style={`background-color: ${vibe.theme.colors.bg}; color: ${vibe.theme.colors.text}`}>
           <!-- Content Container -->
           <div class="p-8 md:p-16 md:py-32 flex flex-col justify-center min-h-[50vh] space-y-16">

               <!-- Introduction -->
               <div class="text-center md:text-left space-y-8">
                   <p class="text-2xl md:text-3xl font-light leading-relaxed opacity-90">
                      Dedicated to the joy of <span class="italic font-display">eating</span> and <span class="italic font-display">drinking</span>.
                   </p>
                   <p class="font-mono text-sm leading-7 max-w-prose opacity-80">
                       Buvette is a place to gather, to share, and to enjoy the simple pleasures of life.
                       Our menu reflects the changing seasons and the best ingredients we can find.
                   </p>
                   <div>
                       <a href="/about" 
                          class="inline-block px-10 py-4 text-sm font-bold uppercase tracking-widest hover:scale-105 transition-all duration-300"
                          style={`background-color: ${vibe.theme.colors.accent}; color: #FFFFFF`}
                       >
                          About Us
                       </a>
                   </div>
               </div>

               <!-- Hours & Location Grid -->
               <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                  <div class="p-8 shadow-sm border border-opacity-20 transition-colors duration-1000" 
                       style={`background-color: ${vibe.theme.colors.surface}; border-color: ${vibe.theme.colors.text}`}>
                      <h2 class="font-display text-2xl mb-4">Hours</h2>
                      <p class="mb-1"><strong>Mon - Fri:</strong> 8am - 12am</p>
                      <p class="mb-1"><strong>Sat - Sun:</strong> 9am - 12am</p>
                      <p class="mt-4 italic text-xs opacity-70">Walk-ins always welcome.</p>
                  </div>
                  <div class="p-8 shadow-sm border border-opacity-20 transition-colors duration-1000"
                       style={`background-color: ${vibe.theme.colors.surface}; border-color: ${vibe.theme.colors.text}`}>
                      <h2 class="font-display text-2xl mb-4">Location</h2>
                      <p class="mb-1">The Forks Market</p>
                      <p class="mb-1">Winnipeg, MB</p>
                      <p class="mt-4"><a href="#" class="underline hover:opacity-80">Get Directions &rarr;</a></p>
                  </div>
               </div>

               <!-- Vibe Engine Debug (Enhanced) -->
               <div class="weather-display bg-stone-200 p-6 font-mono text-xs border border-stone-300 opacity-70 hover:opacity-100 transition-opacity">
                  <h3 class="font-display text-lg mb-4">Vibe Engine Debug</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <p class="font-bold text-stone-500 mb-1 text-[9px] uppercase">Weather</p>
                        <p><strong>Temp:</strong> <span class="temp-number">{vibe.weather.temp}Â°C</span>
                          <span class="text-[9px] opacity-70">
                            (Mental: {vibe.metrics.mentalTemp.toFixed(0)}Â°C)
                          </span>
                        </p>
                        <p><strong>Wind:</strong> {(vibe.weather.windForce * 50).toFixed(0)} km/h</p>
                        <p><strong>Viscosity:</strong> {vibe.weather.viscosity.toFixed(2)}s</p>
                        <p><strong>AQI:</strong> {vibe.weather.usAqi} {vibe.weather.isSmoke && 'ðŸ”¥'}</p>
                        <p><strong>Snow:</strong> {vibe.weather.snowDepth} cm</p>
                    </div>
                    <div>
                        <p class="font-bold text-stone-500 mb-1 text-[9px] uppercase">Context</p>
                        <p><strong>Theme:</strong> {vibe.theme.label}</p>
                        <p><strong>Season:</strong> {vibe.temporal.seasonBias}</p>
                        <p><strong>Deviation:</strong> {vibe.metrics.deviation > 0 ? '+' : ''}{vibe.metrics.deviation.toFixed(1)}Â°</p>
                        <p><strong>Delta (Î”):</strong> {vibe.metrics.deltaShock > 0 ? '+' : ''}{vibe.metrics.deltaShock.toFixed(1)}Â°</p>
                        {vibe.grind.isGrind && <p class="text-red-700"><strong>Grind:</strong> Day {vibe.grind.coldStreakDays + 1}</p>}
                    </div>
                    <div>
                        <p class="font-bold text-stone-500 mb-1 text-[9px] uppercase">Social</p>
                        <p><strong>Jets:</strong> {vibe.social.jetsStatus}</p>
                        {vibe.social.manualOverride !== 'NONE' && <p><strong>Override:</strong> {vibe.social.manualOverride}</p>}
                        {vibe.social.overrideMessage && <p class="italic text-[9px]">"{vibe.social.overrideMessage}"</p>}
                    </div>
                  </div>
                  
                  <!-- Temp Override Slider -->
                  <div class="mt-4 pt-4 border-t border-stone-300">
                      <label for="temp-slider" class="block font-bold mb-2">Simulate Temp: <span id="temp-display">{vibe.weather.temp}Â°C</span></label>
                      <input 
                        type="range" 
                        id="temp-slider" 
                        min="-50" 
                        max="45" 
                        value={vibe.weather.temp}
                        class="w-full h-2 bg-stone-300 rounded-lg appearance-none cursor-pointer accent-stone-800"
                      />
                      <div class="flex justify-between text-[10px] text-stone-500 mt-1">
                          <span>-50Â°C</span>
                          <span>0Â°C</span>
                          <span>+45Â°C</span>
                      </div>
                  </div>

                  <details class="mt-4">
                    <summary class="cursor-pointer font-bold">Raw Context</summary>
                    <pre class="mt-2 text-[10px] overflow-x-auto p-2 bg-stone-100">{JSON.stringify(vibe, null, 2)}</pre>
                  </details>
               </div>

               <script define:vars={{ initialTemp: vibe.weather.temp, seasonBias: vibe.temporal.seasonBias }}>
                  const slider = document.getElementById('temp-slider');
                  const display = document.getElementById('temp-display');
                  const overlay = document.querySelector('.z-5'); // The gradient overlay

                  // Client-side Spring/Fall Gradients (Matched to server logic)
                  const SPRING_GRADIENT = [
                        { temp: -50, color: '#1a0b2e' }, { temp: -30, color: '#172554' },
                        { temp: -10, color: '#0EA5E9' }, { temp: 0,   color: '#06B6D4' },
                        { temp: 10,  color: '#10B981' }, { temp: 20,  color: '#FACC15' },
                        { temp: 30,  color: '#F97316' }, { temp: 45,  color: '#EF4444' }
                  ];
                  const FALL_GRADIENT = [
                        { temp: -50, color: '#1e1b4b' }, { temp: -30, color: '#1e3a8a' },
                        { temp: -10, color: '#475569' }, { temp: 0,   color: '#78716C' },
                        { temp: 10,  color: '#A8A29E' }, { temp: 20,  color: '#D97706' },
                        { temp: 30,  color: '#9a3412' }, { temp: 45,  color: '#7F1D1D' }
                  ];

                  function interpolateColor(color1, color2, factor) {
                      const c1 = parseInt(color1.slice(1), 16);
                      const c2 = parseInt(color2.slice(1), 16);
                      
                      const r1 = (c1 >> 16) & 0xff; const g1 = (c1 >> 8) & 0xff; const b1 = c1 & 0xff;
                      const r2 = (c2 >> 16) & 0xff; const g2 = (c2 >> 8) & 0xff; const b2 = c2 & 0xff;
                      
                      const r = Math.round(r1 + factor * (r2 - r1));
                      const g = Math.round(g1 + factor * (g2 - g1));
                      const b = Math.round(b1 + factor * (b2 - b1));
                      
                      return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
                  }

                  function getColor(temp) {
                      const gradient = seasonBias === 'optimistic' ? SPRING_GRADIENT : FALL_GRADIENT;
                      let lower = gradient[0];
                      let upper = gradient[gradient.length - 1];

                      for (let i = 0; i < gradient.length - 1; i++) {
                          if (temp >= gradient[i].temp && temp <= gradient[i + 1].temp) {
                              lower = gradient[i];
                              upper = gradient[i + 1];
                              break;
                          }
                      }
                      const range = upper.temp - lower.temp;
                      const factor = range === 0 ? 0 : (temp - lower.temp) / range;
                      return interpolateColor(lower.color, upper.color, factor);
                  }

                  // Instant Feedback
                  slider?.addEventListener('input', (e) => {
                      const val = parseFloat(e.target.value);
                      display.textContent = `${val}Â°C`;
                      
                      // Update Overlay Color Instantly
                      const color = getColor(val);
                      if (overlay) {
                        overlay.style.background = `linear-gradient(135deg, ${color}50, ${color}40)`;
                      }
                  });

                  // Server Reload on Release
                  slider?.addEventListener('change', (e) => {
                      const val = e.target.value;
                      const url = new URL(window.location);
                      url.searchParams.set('mockTemp', val);
                      window.location.href = url.toString();
                  });
               </script>

           </div>
      </div>
  </div>
</Layout>

<script>
    // Parallax Effect for the Video
    let cleanupParallax: (() => void) | null = null;

    function handleScroll() {
        const videoElement = document.querySelector('.parallax-video-container video') as HTMLElement;
        if (!videoElement) return;

        const scrolled = window.scrollY;
        const isMobile = window.innerWidth < 768;

        if (isMobile) {
            // On Mobile: The container scrolls with the page.
            // We move the video DOWN (translateY > 0) to counteract the scroll UP.
            // This makes it look like a window.
            const speed = 0.5;
            videoElement.style.transform = `translateY(${scrolled * speed}px)`;
        } else {
            // On Desktop: The container is STICKY. It stays at top:0.
            // As we scroll the page (the right side scrolls), the sticky container stays.
            // We can add a subtle effect to make it feel less static, but 'sticky' is the main effect.
            // Let's add a very subtle 'drift' to show depth.
            const speed = 0.05;
            videoElement.style.transform = `scale(1.05) translateY(${scrolled * speed}px)`;
        }
    }

    function setupParallax() {
        // Clean up previous listener if it exists to be safe
        if (cleanupParallax) cleanupParallax();

        const videoElement = document.querySelector('.parallax-video-container video');
        if (!videoElement) return; // Not on this page or element not found

        window.addEventListener('scroll', handleScroll);

        cleanupParallax = () => {
            window.removeEventListener('scroll', handleScroll);
            cleanupParallax = null;
        };
    }

    // Astro View Transitions events
    document.addEventListener('astro:page-load', setupParallax);

    document.addEventListener('astro:before-swap', () => {
        if (cleanupParallax) cleanupParallax();
    });
</script>
